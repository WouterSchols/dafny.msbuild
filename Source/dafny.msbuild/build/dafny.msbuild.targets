<Project>
    <!-- TODO: hook this up as a CodeAnalysis plugin instead? -->
    <Target Name="VerifyDafny">
        <DafnyVerifyTask DafnySourceFiles="@(DafnySource)" 
                         DafnyExecutable="$(DafnyBinariesDir)$(Dafny)"
                         Jobs="$(VerifyDafnyJobs)"
                         DafnyVerificationParams="@(VerifyDafnyPassthrough)" />
    </Target>
    
    <Target Name="CompileDafny"
            AfterTargets="ResolveReferences"
            BeforeTargets="CoreCompile"
            Inputs="$(MSBuildProjectFile);@(DafnySource)"
            Outputs="$(IntermediateOutputPath)GeneratedFromDafny.cs">
        <PropertyGroup>
            <DafnyOutputFile>$(IntermediateOutputPath)GeneratedFromDafny.cs</DafnyOutputFile>
			<AutoGenerateBindingRedirects>true</AutoGenerateBindingRedirects>
        </PropertyGroup>
        <Message Text="Compiling Dafny source files to $(DafnyOutputFile)..." Importance="high"/>
		<DafnyCompileTask DafnySourceFiles="@(DafnySource)"
                         DafnyExecutable="$(DafnyBinariesDir)$(Dafny)"
						 DafnyOutputFile="$(DafnyOutputFile)"
                         Jobs="$(CompileDafnyJobs)"
                         DafnyCompileParams="@(CompileDafnyPassthrough)" />
		<ItemGroup>
            <Compile Include="$(DafnyOutputFile)" />
            <!-- Register the generated file to be deleted when cleaning -->
            <FileWrites Include="$(DafnyOutputFile)"/>
        </ItemGroup>
    </Target>

    <!-- TODO: Define Inputs and Outputs for this -->
    <Target Name="CompileDafnyToJS">
        <Exec Command="$(Dafny) /out:build/Main @(DafnySource, ' ') /compile:2 /noVerify /noIncludes /compileTarget:js /spillTargetCode:1" />
    </Target>
</Project>
